---
title: 'Laboratorio 1: Análisis CineVision'
output:
  html_document: default
  pdf_document: default
date: "2026-02-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(nortest)
library(scales)
library(lubridate)
```

```{r cargar_datos}
movies <- read.csv("movies_2026.csv", stringsAsFactors = FALSE)
```
### **Repositorio de Github: https://github.com/yosemm/Laboratorio1 **

### Ejercicio 1: Exploración inicial

##### *Haga una exploración rápida de sus datos, para eso haga un resumen de su conjunto de datos.* 

Se realiza una exploración rápida de los datos.

```{r exploracion}
# Ver estructura general
glimpse(movies)

# Resumen
summary(movies)
```

A simple vista, se ve que se tratan de 19,883 filas y 28 columnas. En las fila de revenue y budget, el valor más bajo es de 0. Mientras que en las filas de productionCompany, productionCompanyCountry y productionCountry, hay valores vacíos. Lo cual puede indicar dificultades al momento de conseguir los datos.

### Ejercicio 2: Clasificación de Variables
##### *Diga el tipo de cada una de las variables (cualitativa ordinal o nominal, cuantitativa continua, cuantitativa discreta)*  

Basado en la descripción de las variables y el contenido del dataset, la clasificación es la siguiente:

| Variable | Tipo de Variable |
|:---------|:-----------------|
|**id**| Cuantitativa Continua |
| **budget** | Cuantitativa Continua |
| **revenue** | Cuantitativa Continua |
| **runtime** | Cuantitativa Discreta |
| **voteAvg** | Cuantitativa Continua |
| **voteCount**| Cuantitativa Discreta |
| **genres** | Cualitativa Nominal | 
| **originalLanguage** | Cualitativa Nominal |
| **releaseYear** | Cuantitativa Discreta | 
| **video** | Cualitativa Nominal | 
| **homePage**| Cualitativa Nominal |
| **productionCompany** | Cualitativa Nominal |
| **productionCompanyCountry** | Cualitativa Nominal |
| **productionCountry** | Cualitativa Nominal |
| **director** | Cualitativa Nominal |
| **actors** | Cualitativa Nominal |
| **actorsPopularity** | Cuantitativa Continua |
| **actorsCharacter** | Cualitativa Nominal |
| **originalTitle** | Cualitativa Nominal |
| **title** | Cualitativa Nominal |
| **popularity** | Cuantitativa Continua |
| **releaseDate**| Cualitativa Nominal |
| **genresAmount** | Cuantitativa Discreta |
| **productionCoAmount** | Cuantitativa Discreta |
| **productionCountriesAmount** | Cuantitativa Discreta |
| **actorsAmount** | Cuantitativa Discreta |
| **castWomenAmount** | Cuantitativa Discreta |
| **castMenAmount** | Cuantitativa Discreta |

### Ejercicio 3: Distribución de Variables
##### *Investigue si las variables cuantitativas siguen una distribución normal y haga una tabla de frecuencias de las variables cualitativas.* 

```{r analisis_normalidad, fig.height=10, fig.width=8}
# Guardar las variables cuantitativas relevantes
vars_cuantitativas <- movies %>%
  select(budget, revenue, runtime, voteAvg, voteCount, genresAmount, productionCoAmount, productionCountriesAmount, actorsAmount, castWomenAmount, castMenAmount, popularity, voteCount) %>%
  drop_na() # Eliminamos NAs

# 1. Visualización: Histogramas
vars_cuantitativas %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Valor") %>%
  ggplot(aes(x = Valor)) +
  geom_histogram(bins = 30, fill = "cornflowerblue", color = "black") +
  facet_wrap(~Variable, scales = "free", ncol = 2) +
  theme_minimal() +
  labs(title = "Histogramas de Variables Cuantitativas", y = "Frecuencia")

# 2. Visualización: Boxplots (Diagramas de Caja)
vars_cuantitativas %>%
  pivot_longer(cols = everything(), names_to = "Variable", values_to = "Valor") %>%
  ggplot(aes(x = Variable, y = Valor)) +
  geom_boxplot(fill = "orange", alpha = 0.7) +
  facet_wrap(~Variable, scales = "free", ncol = 2) +
  theme_minimal() +
  labs(title = "Boxplots de Variables Cuantitativas", y = "Valor")

```

```{r pruebas_estadisticas, warning=FALSE}
# Función para aplicar tests
analizar_normalidad <- function(columna, nombre) {
  # Prueba de Kolmogorov-Smirnov
  ks <- ks.test(columna, "pnorm", mean(columna), sd(columna))
  
  # Prueba de Lilliefors
  lillie <- lillie.test(columna)
  
  return(data.frame(
    Variable = nombre,
    KS_p_value = ks$p.value,
    Lillie_p_value = lillie$p.value,
    Es_Normal = ifelse(lillie$p.value > 0.05, "Sí", "No")
  ))
}

# Aplicamos la función
resultados <- bind_rows(
  analizar_normalidad(movies$budget, "Budget"),
  analizar_normalidad(movies$revenue, "Revenue"),
  analizar_normalidad(movies$voteAvg, "VoteAvg"),
  analizar_normalidad(movies$popularity, "Popularity"),
  analizar_normalidad(movies$runtime[movies$runtime > 0], "Runtime"),
  analizar_normalidad(movies$voteCount, "VoteCount"),
  analizar_normalidad(movies$genresAmount, "GenresAmount"),
  analizar_normalidad(movies$productionCoAmount, "ProductionCoAmount"),
  analizar_normalidad(movies$productionCountriesAmount, "ProductionCountriesAmount"),
  analizar_normalidad(movies$actorsAmount, "ActorsAmount"),
  analizar_normalidad(movies$castWomenAmount[!is.na(movies$castWomenAmount)], "CastWomenAmount"),
  analizar_normalidad(movies$castMenAmount[!is.na(movies$castMenAmount)], "CastMenAmount")
)

print(resultados)
```
Removimos los valores nulos y ceros en las variables donde es necesario para evitar errores en las pruebas estadísticas.

#### 3.3 Tablas de Frecuencia (Variables Cualitativas)

A continuación se muestran las frecuencias de variables categóricas.

```{r tablas_frecuencia}
# 1. Tabla de Frecuencias: Idioma Original (Top 10)
movies %>%
  count(originalLanguage, sort = TRUE) %>%
  head(10) %>% 
  mutate(Porcentaje = round(n / sum(movies %>% count(originalLanguage) %>% pull(n)) * 100, 2)) %>%
  knitr::kable(caption = "Top 10 Idiomas Originales más frecuentes")

# 2. Tabla de Frecuencias: Géneros
movies %>%
  # Separamos los géneros por la barra vertical "|"
  separate_rows(genres, sep = "\\|") %>%
  filter(genres != "") %>%
  count(genres, sort = TRUE) %>%
  mutate(Porcentaje = round(n / sum(n) * 100, 2)) %>%
  knitr::kable(caption="Frecuencia de Géneros (considerando cada género por separado)")

# 3. Tabla de Frecuencias: País de Producción (Top 10)
movies %>%
  # Eliminar los que están vacíos
  filter(productionCountry != "") %>%
  # Corregir "US" para que se combine con United States of America
  mutate(productionCountry = ifelse(productionCountry == "US", "United States of America", productionCountry)) %>% 
  count(productionCountry, sort = TRUE) %>%
  head(10) %>%
  mutate(Porcentaje = round(n / sum(n) * 100, 2)) %>%
  knitr::kable(caption = "Top 10 Países de Producción")

# 4. Tabla de Frecuencias: Compañía Productora (Top 10)
movies %>%
  filter(productionCompany != "") %>%
  count(productionCompany, sort = TRUE) %>%
  head(10) %>%
  mutate(Porcentaje = round(n / sum(movies %>% count(productionCompany) %>% pull(n)) * 100, 2)) %>%
  knitr::kable(caption = "Top 10 Compañías Productoras")

# 5. Tabla de Frecuencia simple: Video
movies %>%
  count(video) %>%
  mutate(Porcentaje = round(n / sum(n) * 100, 2)) %>%
  knitr::kable(caption = "Distribución de variable Video")
```

### Ejercicio 4
##### *Responda las siguientes preguntas:*

**4.1 ¿Cuáles son las 10 películas que contaron con más presupuesto?**
```{r top_presupuesto}
options(scipen = 999)
top_budget <- movies %>%
  select(title, budget) %>%
  arrange(desc(budget)) %>%
  head(10)%>%
  mutate(budget = comma(budget))

knitr::kable(top_budget)
```

**4.2 ¿Cuáles son las 10 películas que más ingresos tuvieron?**
```{r top_ingresos}
top_revenue <- movies %>%
  select(title, revenue) %>%
  arrange(desc(revenue)) %>%
  head(10) %>%
  mutate(revenue = comma(revenue))

knitr::kable(top_revenue)
```

**4.3 ¿Cuál es la película que más votos tuvo?**
```{r top_votos}
top_votos <- movies %>%
  select(title, voteCount) %>%
  arrange(desc(voteCount)) %>%
  head(1)
knitr::kable(top_votos)
```

**4.4  ¿Cuál es la peor película de acuerdo a los votos de todos los usuarios?**
```{r peor_pelicula}
peor_pelicula <- movies %>%
  select(title, voteAvg, voteCount) %>%
  filter(voteCount > 100) %>%
  arrange(voteAvg) %>%
  head(1)
knitr::kable(peor_pelicula)
```
Agregamos un filtro para tomar las peliculas que sí recibieron varios votos.

**4.5 ¿Cuántas películas se hicieron en cada año? ¿En qué año se hicieron más películas? Haga un gráfico de barras**

```{r pelis_año}

peliculas_por_anio <- movies %>%
  filter(!is.na(releaseYear) & releaseYear > 0) %>%
  count(releaseYear) %>%
  rename(Anio = releaseYear, Cantidad = n)

anio_max <- peliculas_por_anio %>%
  arrange(desc(Cantidad)) %>%
  slice(1)

print(paste("El año en que se hicieron más películas fue:", anio_max$Anio, "con", anio_max$Cantidad, "películas."))

# Gráfico de Barras
ggplot(peliculas_por_anio, aes(x = Anio, y = Cantidad)) +
  geom_col(fill = "steelblue") +
  theme_minimal() +
  labs(
    title = "Cantidad de Películas producidas por Año",
    subtitle = paste("El pico máximo fue en", anio_max$Anio),
    x = "Año de Lanzamiento",
    y = "Cantidad de Películas"
  ) +
  scale_x_continuous(breaks = seq(min(peliculas_por_anio$Anio), max(peliculas_por_anio$Anio), by = 10))

```

**4.6 ¿Cuál es el género principal de las 20 películas más recientes? ¿Cuál es el género principal que predomina en el conjunto de datos? Represéntelo usando un gráfico. ¿A qué género principal pertenecen las películas más largas?**

```{r analisis de generos, message=FALSE, warning=FALSE}

# Pre-procesamiento: 
movies_proc <- movies %>%
  mutate(
    genero_principal = str_extract(genres, "^[^|]+"),
    fecha_lanzamiento = as.Date(releaseDate)
  ) %>%
  filter(!is.na(genero_principal) & genero_principal != "")

top_recientes <- movies_proc %>%
  arrange(desc(fecha_lanzamiento)) %>%
  head(20) %>%
  count(genero_principal, sort = TRUE)

knitr::kable(top_recientes, caption = "4.6a: Géneros de las 20 películas más recientes")

# Género predominante
conteo_generos <- movies_proc %>%
  count(genero_principal, sort = TRUE) 
genero_top <- conteo_generos$genero_principal[1]
print(paste("El género que predomina en todo el dataset es:", genero_top))

# Gráfico Top 10 Géneros
ggplot(head(conteo_generos, 10), aes(x = reorder(genero_principal, n), y = n)) +
  geom_col(fill = "darkcyan") +
  coord_flip() +
  labs(title = "Top 10 Géneros Principales", x = "Género", y = "Cantidad") +
  theme_minimal()

# Género de las películas más largas
mas_largas <- movies_proc %>%
  arrange(desc(runtime)) %>%
  head(10) %>%
  select(title, runtime, genero_principal)

knitr::kable(mas_largas, caption = "4.6c: Género de las 10 películas más largas")
```

**4.7. ¿Las películas de qué género obtuvieron mayores ganancias?**

```{r mayores_ganancias}
ganancias_genero <- movies_proc %>%
  group_by(genero_principal) %>%
  summarise(
    Ingreso_Total = sum(revenue, na.rm = TRUE),
    Ingreso_Promedio = mean(revenue, na.rm = TRUE)
  ) %>%
  arrange(desc(Ingreso_Total)) %>%
  head(10) %>%
  mutate(
    Ingreso_Total = comma(Ingreso_Total),
    Ingreso_Promedio = comma(Ingreso_Promedio)
  )


knitr::kable(ganancias_genero)
```
